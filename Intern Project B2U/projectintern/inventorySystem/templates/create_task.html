{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Assigned Tasks - Beyond2U</title>
<style>
body {
    font-family:'Segoe UI', sans-serif;
    margin:0;
    background:linear-gradient(135deg,#f9fbff,#fffbea);
    color:#333;
    display:flex;
    min-height:100vh;
}
.sidebar {
    width:230px;
    background:linear-gradient(180deg,#004aad,#5c9eff);
    color:white;
    padding:35px 20px;
    display:flex;
    flex-direction:column;
    box-shadow:4px 0 18px rgba(0,0,0,0.1);
    border-top-right-radius:22px;
    border-bottom-right-radius:22px;
    z-index: 3;
}
.sidebar h2 {
    font-size:26px;
    text-align:center;
    margin-bottom:40px;
    color:#ffeb70;
    text-shadow:0 0 6px rgba(255,255,255,0.3);
}
.sidebar a {
    display:block;
    color:#fff;
    text-decoration:none;
    padding:12px 15px;
    margin-bottom:12px;
    border-radius:10px;
    transition:all 0.3s ease;
    font-weight:500;
    text-align:center;
    background:rgba(255,255,255,0.15);
}
.sidebar a:hover {
    background:#ffda47;
    color:#004aad;
    font-weight:600;
    transform:translateY(-3px);
}
.content {
    flex:1;
    padding:50px 60px;
    position: relative;
    z-index: 1;
}
h1 {
    color:#004aad;
    font-size:30px;
    margin-bottom:25px;
}
.search-bar {
    display:flex;
    justify-content:flex-end;
    margin-bottom:20px;
}
.search-bar input {
    width:300px;
    padding:10px 15px;
    border:2px solid #004aad;
    border-radius:8px;
    font-size:15px;
}
.task-table {
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 6px 20px rgba(0,84,200,0.1);
    position: relative;
    z-index: 1;
}
.task-table th, .task-table td {
    padding:15px;
    text-align:left;
    border-bottom:1px solid #e0ecff;
}
.task-table th {
    background-color:#004aad;
    color:white;
    font-size:16px;
}
.task-table tr:hover { background-color:#f1f5ff; }
.action-btn {
    background-color:#004aad;
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition:0.3s;
    position: relative;
    z-index: 2;
}
.action-btn:hover { background-color:#003080; transform:translateY(-2px); }

.modal {
    display:none;
    position:fixed;
    z-index:10;
    left:0;
    top:0;
    width:100%;
    height:100%;
    background-color:rgba(0,0,0,0.4);
}
.modal-content {
    background-color:#fff;
    margin:5% auto;
    padding:25px;
    border-radius:16px;
    width:650px;
    box-shadow:0 8px 20px rgba(0,0,0,0.2);
    border-top:5px solid #004aad;
}
.modal-content h2 { color:#004aad; text-align:center; margin-bottom:20px; }
.modal-content input, .modal-content textarea {
    width:100%;
    margin-bottom:10px;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    background-color:#f5f5f5;
}
.modal-content textarea { min-height:60px; resize:none; }
.modal-buttons { text-align:right; margin-top:10px; }
.close-btn {
    padding:8px 16px;
    border:none;
    border-radius:8px;
    background:#004aad;
    color:white;
    cursor:pointer;
}
.close-btn:hover { background:#003080; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>Beyond2U</h2>
    <a href="{% url 'systemengineer_dashboard' %}">üè† Dashboard</a>
    <a href="{% url 'create_task' %}">‚ûï Create Task</a>
    <a href="{% url 'my_submissions' %}">üìÑ My Submissions</a>
    <a href="{% url 'notifications' %}">üîî Notifications</a>
    <a href="{% url 'logout' %}">üö™ Logout</a>
</div>

<div class="content">
<h1>Your Assigned Tasks üë∑‚Äç‚ôÇÔ∏è</h1>

<div class="search-bar">
  <input type="text" id="taskSearch" placeholder="Search by user or replacement type...">
</div>

<table class="task-table" id="taskTable">
  <thead>
    <tr>
      <th>User</th>
      <th>Replacement Type</th>
      <th>Location</th>
      <th>Assigned Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for task in assigned_tasks %}
    <tr>
      <td>{{ task.username }}</td>
      <td>{{ task.replacement_type }}</td>
      <td>{{ task.location }}</td>
      <td>{{ task.assigned_date|date:"Y-m-d H:i" }}</td>
      <td>
        <button class="action-btn" onclick="openUpdateModal('{{ task.barcode }}')">Update</button>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="5">No tasks assigned to you yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

<!-- Modal -->
<div id="updateModal" class="modal">
  <div class="modal-content">
    <h2>Task Details</h2>
    <form>
      {% csrf_token %}
      <label>Engineer Name:</label>
      <input type="text" id="modalEngineer" readonly>
      <label>User Name:</label>
      <input type="text" id="modalUser" readonly>
      <label>Location:</label>
      <input type="text" id="modalLocation" readonly>
      <label>Old Hostname:</label>
      <input type="text" id="modalOldHostname" readonly>
      <label>New Hostname:</label>
      <input type="text" id="modalNewHostname" readonly>
      <label>Old Serial Number:</label>
      <input type="text" id="modalOldSerial" readonly>
      <label>New Serial Number:</label>
      <input type="text" id="modalNewSerial" readonly>
      <label>Status:</label>
      <input type="text" id="modalStatus" readonly>
      <label>Rescheduled Date:</label>
      <input type="text" id="modalReschedule" readonly>
      <label>Format Status:</label>
      <input type="text" id="modalFormatStatus" readonly>
      <label>Reason (Not Formatted):</label>
      <input type="text" id="modalReasonFormat" readonly>
      <label>Upload Status:</label>
      <input type="text" id="modalUploadStatus" readonly>
      <label>Reason (Not Uploaded):</label>
      <input type="text" id="modalReasonUpload" readonly>
      <label>Remarks:</label>
      <textarea id="modalRemarks" readonly></textarea>
      <div class="modal-buttons">
        <button type="button" class="close-btn" onclick="closeUpdateModal()">Close</button>
      </div>
    </form>
  </div>
</div>

<script>
const tasks = JSON.parse('{{ tasks_json|escapejs }}');

function openUpdateModal(taskBarcode) {
    const taskObj = tasks.find(t => t.fields.barcode == taskBarcode).fields;

    document.getElementById('modalEngineer').value = taskObj.engineer;
    document.getElementById('modalUser').value = taskObj.username;
    document.getElementById('modalLocation').value = taskObj.location;
    document.getElementById('modalOldHostname').value = taskObj.old_hostname || '';
    document.getElementById('modalNewHostname').value = taskObj.new_hostname || '';
    document.getElementById('modalOldSerial').value = taskObj.old_serial || '';
    document.getElementById('modalNewSerial').value = taskObj.new_serial || '';
    document.getElementById('modalStatus').value = taskObj.status;
    document.getElementById('modalReschedule').value = taskObj.rescheduled_date || '';
    document.getElementById('modalFormatStatus').value = taskObj.format_status || '';
    document.getElementById('modalReasonFormat').value = taskObj.reason_not_formatted || '';
    document.getElementById('modalUploadStatus').value = taskObj.upload_status || '';
    document.getElementById('modalReasonUpload').value = taskObj.reason_not_uploaded || '';
    document.getElementById('modalRemarks').value = taskObj.remarks || '';

    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
}

// Search filter
document.getElementById("taskSearch").addEventListener("keyup", function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("#taskTable tbody tr");
    rows.forEach(row => {
        const user = row.cells[0].textContent.toLowerCase();
        const type = row.cells[1].textContent.toLowerCase();
        row.style.display = (user.includes(filter) || type.includes(filter)) ? "" : "none";
    });
});

// Close modal on click outside
window.onclick = function(event) {
    const modal = document.getElementById("updateModal");
    if(event.target == modal) modal.style.display = "none";
}
</script>

</body>
</html>
